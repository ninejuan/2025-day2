#!/bin/bash
yum update -y
yum install -y python3 python3-pip docker git amazon-ssm-agent

# SSM Agent 시작 및 활성화
systemctl start amazon-ssm-agent
systemctl enable amazon-ssm-agent

systemctl start docker
systemctl enable docker
usermod -a -G docker ec2-user

curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
./aws/install

REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region)
ECR_REPO_URL="${ecr_repository_url}"

if [ -n "$ECR_REPO_URL" ]; then
    aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin $ECR_REPO_URL
    docker pull $ECR_REPO_URL:latest || echo "ECR image not found"
    
    if docker image inspect $ECR_REPO_URL:latest > /dev/null 2>&1; then
        docker run -d --name app-server -p 8000:8000 --restart always $ECR_REPO_URL:latest
    else
        echo "Running fallback"
        pip3 install fastapi uvicorn boto3 pydantic
        
        mkdir -p /home/ec2-user/app
        echo "ZnJvbSBmYXN0YXBpIGltcG9ydCBGYXN0QVBJLCBIVFRQRXhjZXB0aW9uLCBSZXF1ZXN0DQpmcm9tIGZhc3RhcGkucmVzcG9uc2VzIGltcG9ydCBKU09OUmVzcG9uc2UNCmZyb20gcHlkYW50aWMgaW1wb3J0IEJhc2VNb2RlbA0KaW1wb3J0IGJvdG8zDQpmcm9tIGJvdG9jb3JlLmV4Y2VwdGlvbnMgaW1wb3J0IENsaWVudEVycm9yDQppbXBvcnQganNvbg0KZnJvbSB0eXBpbmcgaW1wb3J0IE9wdGlvbmFsLCBMaXN0LCBEaWN0LCBBbnkNCmltcG9ydCB1dmljb3JuDQoNClRBQkxFX05BTUUgPSAnc2tpbGxzLWFwcC10YWJsZScNClJFR0lPTl9OQU1FID0gJ2FwLXNvdXRoZWFzdC0xJw0KSE9TVCA9ICIwLjAuMC4wIg0KUE9SVCA9IDgwMDANCg0KY2xhc3MgU2V0dGluZ3M6DQogICAgdGFibGVfbmFtZTogc3RyID0gVEFCTEVfTkFNRQ0KICAgIHJlZ2lvbl9uYW1lOiBzdHIgPSBSRUdJT05fTkFNRQ0KICAgIGhvc3Q6IHN0ciA9IEhPU1QNCiAgICBwb3J0OiBpbnQgPSBQT1JUDQoNCnNldHRpbmdzID0gU2V0dGluZ3MoKQ0KDQpjbGFzcyBQcmV0dHlKU09OUmVzcG9uc2UoSlNPTlJlc3BvbnNlKToNCiAgICBkZWYgcmVuZGVyKHNlbGYsIGNvbnRlbnQ6IEFueSkgLT4gYnl0ZXM6DQogICAgICAgIHJldHVybiAoanNvbi5kdW1wcyhjb250ZW50LCBpbmRlbnQ9MikgKyAiXG4iKS5lbmNvZGUoInV0Zi04IikNCg0KYXBwID0gRmFzdEFQSShkZWZhdWx0X3Jlc3BvbnNlX2NsYXNzPVByZXR0eUpTT05SZXNwb25zZSkNCg0KQGFwcC5leGNlcHRpb25faGFuZGxlcihIVFRQRXhjZXB0aW9uKQ0KYXN5bmMgZGVmIGN1c3RvbV9odHRwX2V4Y2VwdGlvbl9oYW5kbGVyKHJlcXVlc3Q6IFJlcXVlc3QsIGV4YzogSFRUUEV4Y2VwdGlvbik6DQogICAgcmV0dXJuIFByZXR0eUpTT05SZXNwb25zZSgNCiAgICAgICAgc3RhdHVzX2NvZGU9ZXhjLnN0YXR1c19jb2RlLA0KICAgICAgICBjb250ZW50PXsiZGV0YWlsIjogZXhjLmRldGFpbH0NCiAgICApDQoNCmNsYXNzIFVzZXIoQmFzZU1vZGVsKToNCiAgICBVc2VySWQ6IHN0cg0KICAgIE5hbWU6IHN0cg0KICAgIFNraWxsTGV2ZWw6IE9wdGlvbmFsW3N0cl0gPSBOb25lDQoNCmNsYXNzIFVzZXJVcGRhdGUoQmFzZU1vZGVsKToNCiAgICBOYW1lOiBPcHRpb25hbFtzdHJdID0gTm9uZQ0KICAgIFNraWxsTGV2ZWw6IE9wdGlvbmFsW3N0cl0gPSBOb25lDQoNCmNsYXNzIER5bmFtb0RCU2VydmljZToNCiAgICBkZWYgX19pbml0X18oc2VsZik6DQogICAgICAgIHNlbGYuZHluYW1vZGIgPSBib3RvMy5yZXNvdXJjZSgnZHluYW1vZGInLCByZWdpb25fbmFtZT1zZXR0aW5ncy5yZWdpb25fbmFtZSkNCiAgICAgICAgc2VsZi50YWJsZSA9IHNlbGYuZHluYW1vZGIuVGFibGUoc2V0dGluZ3MudGFibGVfbmFtZSkNCg0KICAgIGRlZiBoZWFsdGhfY2hlY2soc2VsZikgLT4gYm9vbDoNCiAgICAgICAgIiIiQ2hlY2sgRHluYW1vREIgY29ubmVjdGlvbiBzdGF0dXMiIiINCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgc2VsZi50YWJsZS50YWJsZV9zdGF0dXMNCiAgICAgICAgICAgIHJldHVybiBUcnVlDQogICAgICAgIGV4Y2VwdCBDbGllbnRFcnJvcjoNCiAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgZGVmIGNyZWF0ZV91c2VyKHNlbGYsIHVzZXI6IFVzZXIpIC0+IE5vbmU6DQogICAgICAgICIiIkNyZWF0ZSBhIG5ldyB1c2VyIiIiDQogICAgICAgIHRyeToNCiAgICAgICAgICAgIHNlbGYudGFibGUucHV0X2l0ZW0oDQogICAgICAgICAgICAgICAgSXRlbT11c2VyLmRpY3QoZXhjbHVkZV9ub25lPVRydWUpLA0KICAgICAgICAgICAgICAgIENvbmRpdGlvbkV4cHJlc3Npb249ImF0dHJpYnV0ZV9ub3RfZXhpc3RzKFVzZXJJZCkiDQogICAgICAgICAgICApDQogICAgICAgIGV4Y2VwdCBDbGllbnRFcnJvciBhcyBlOg0KICAgICAgICAgICAgaWYgZS5yZXNwb25zZVsnRXJyb3InXVsnQ29kZSddID09ICdDb25kaXRpb25hbENoZWNrRmFpbGVkRXhjZXB0aW9uJzoNCiAgICAgICAgICAgICAgICByYWlzZSBIVFRQRXhjZXB0aW9uKHN0YXR1c19jb2RlPTQwMCwgZGV0YWlsPSJVc2VySWQgYWxyZWFkeSBleGlzdHMiKQ0KICAgICAgICAgICAgcmFpc2UgSFRUUEV4Y2VwdGlvbihzdGF0dXNfY29kZT01MDAsIGRldGFpbD1mIkVycm9yIGNyZWF0aW5nIHVzZXI6IHtzdHIoZSl9IikNCg0KICAgIGRlZiBnZXRfdXNlcihzZWxmLCB1c2VyX2lkOiBzdHIpIC0+IERpY3Rbc3RyLCBBbnldOg0KICAgICAgICAiIiJSZXRyaWV2ZSBhIHVzZXIgYnkgSUQiIiINCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLnRhYmxlLmdldF9pdGVtKEtleT17J1VzZXJJZCc6IHVzZXJfaWR9KQ0KICAgICAgICAgICAgaXRlbSA9IHJlc3BvbnNlLmdldCgnSXRlbScpDQogICAgICAgICAgICBpZiBub3QgaXRlbToNCiAgICAgICAgICAgICAgICByYWlzZSBIVFRQRXhjZXB0aW9uKHN0YXR1c19jb2RlPTQwNCwgZGV0YWlsPSJVc2VyIG5vdCBmb3VuZCIpDQogICAgICAgICAgICByZXR1cm4gaXRlbQ0KICAgICAgICBleGNlcHQgQ2xpZW50RXJyb3IgYXMgZToNCiAgICAgICAgICAgIHJhaXNlIEhUVFBFeGNlcHRpb24oc3RhdHVzX2NvZGU9NTAwLCBkZXRhaWw9ZiJFcnJvciByZXRyaWV2aW5nIHVzZXI6IHtzdHIoZSl9IikNCg0KICAgIGRlZiBsaXN0X3VzZXJzKHNlbGYpIC0+IExpc3RbRGljdFtzdHIsIEFueV1dOg0KICAgICAgICAiIiJMaXN0IGFsbCB1c2VycyIiIg0KICAgICAgICB0cnk6DQogICAgICAgICAgICByZXNwb25zZSA9IHNlbGYudGFibGUuc2NhbigpDQogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZ2V0KCdJdGVtcycsIFtdKQ0KICAgICAgICBleGNlcHQgQ2xpZW50RXJyb3IgYXMgZToNCiAgICAgICAgICAgIHJhaXNlIEhUVFBFeGNlcHRpb24oc3RhdHVzX2NvZGU9NTAwLCBkZXRhaWw9ZiJFcnJvciBzY2FubmluZyB1c2Vyczoge3N0cihlKX0iKQ0KDQogICAgZGVmIHVwZGF0ZV91c2VyKHNlbGYsIHVzZXJfaWQ6IHN0ciwgdXNlcl91cGRhdGU6IFVzZXJVcGRhdGUpIC0+IERpY3Rbc3RyLCBBbnldOg0KICAgICAgICAiIiJVcGRhdGUgdXNlciBpbmZvcm1hdGlvbiIiIg0KICAgICAgICB1cGRhdGVfZXhwcmVzc2lvbiA9ICJTRVQiDQogICAgICAgIGV4cHJlc3Npb25fYXR0cmlidXRlX3ZhbHVlcyA9IHt9DQogICAgICAgIGV4cHJlc3Npb25fYXR0cmlidXRlX25hbWVzID0ge30NCg0KICAgICAgICBpZiB1c2VyX3VwZGF0ZS5OYW1lOg0KICAgICAgICAgICAgdXBkYXRlX2V4cHJlc3Npb24gKz0gIiAjbiA9IDpuYW1lLCINCiAgICAgICAgICAgIGV4cHJlc3Npb25fYXR0cmlidXRlX3ZhbHVlc1siOm5hbWUiXSA9IHVzZXJfdXBkYXRlLk5hbWUNCiAgICAgICAgICAgIGV4cHJlc3Npb25fYXR0cmlidXRlX25hbWVzWyIjbiJdID0gIk5hbWUiDQogICAgICAgIGlmIHVzZXJfdXBkYXRlLlNraWxsTGV2ZWw6DQogICAgICAgICAgICB1cGRhdGVfZXhwcmVzc2lvbiArPSAiIFNraWxsTGV2ZWwgPSA6c2tpbGwsIg0KICAgICAgICAgICAgZXhwcmVzc2lvbl9hdHRyaWJ1dGVfdmFsdWVzWyI6c2tpbGwiXSA9IHVzZXJfdXBkYXRlLlNraWxsTGV2ZWwNCg0KICAgICAgICBpZiBub3QgZXhwcmVzc2lvbl9hdHRyaWJ1dGVfdmFsdWVzOg0KICAgICAgICAgICAgcmFpc2UgSFRUUEV4Y2VwdGlvbihzdGF0dXNfY29kZT00MDAsIGRldGFpbD0iTm8gZmllbGRzIHRvIHVwZGF0ZSIpDQoNCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLnRhYmxlLnVwZGF0ZV9pdGVtKA0KICAgICAgICAgICAgICAgIEtleT17J1VzZXJJZCc6IHVzZXJfaWR9LA0KICAgICAgICAgICAgICAgIFVwZGF0ZUV4cHJlc3Npb249dXBkYXRlX2V4cHJlc3Npb24ucnN0cmlwKCIsIiksDQogICAgICAgICAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcz1leHByZXNzaW9uX2F0dHJpYnV0ZV92YWx1ZXMsDQogICAgICAgICAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzPWV4cHJlc3Npb25fYXR0cmlidXRlX25hbWVzIG9yIE5vbmUsDQogICAgICAgICAgICAgICAgUmV0dXJuVmFsdWVzPSJBTExfTkVXIg0KICAgICAgICAgICAgKQ0KICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlWydBdHRyaWJ1dGVzJ10NCiAgICAgICAgZXhjZXB0IENsaWVudEVycm9yIGFzIGU6DQogICAgICAgICAgICBpZiBlLnJlc3BvbnNlWydFcnJvciddWydDb2RlJ10gPT0gJ1ZhbGlkYXRpb25FeGNlcHRpb24nOg0KICAgICAgICAgICAgICAgIHJhaXNlIEhUVFBFeGNlcHRpb24oc3RhdHVzX2NvZGU9NDA0LCBkZXRhaWw9IlVzZXIgbm90IGZvdW5kIikNCiAgICAgICAgICAgIHJhaXNlIEhUVFBFeGNlcHRpb24oc3RhdHVzX2NvZGU9NTAwLCBkZXRhaWw9ZiJFcnJvciB1cGRhdGluZyB1c2VyOiB7c3RyKGUpfSIpDQoNCiAgICBkZWYgZGVsZXRlX3VzZXIoc2VsZiwgdXNlcl9pZDogc3RyKSAtPiBOb25lOg0KICAgICAgICAiIiJEZWxldGUgYSB1c2VyIiIiDQogICAgICAgIHRyeToNCiAgICAgICAgICAgIHNlbGYudGFibGUuZGVsZXRlX2l0ZW0oDQogICAgICAgICAgICAgICAgS2V5PXsnVXNlcklkJzogdXNlcl9pZH0sDQogICAgICAgICAgICAgICAgQ29uZGl0aW9uRXhwcmVzc2lvbj0iYXR0cmlidXRlX2V4aXN0cyhVc2VySWQpIg0KICAgICAgICAgICAgKQ0KICAgICAgICBleGNlcHQgQ2xpZW50RXJyb3IgYXMgZToNCiAgICAgICAgICAgIGlmIGUucmVzcG9uc2VbJ0Vycm9yJ11bJ0NvZGUnXSA9PSAnQ29uZGl0aW9uYWxDaGVja0ZhaWxlZEV4Y2VwdGlvbic6DQogICAgICAgICAgICAgICAgcmFpc2UgSFRUUEV4Y2VwdGlvbihzdGF0dXNfY29kZT00MDQsIGRldGFpbD0iVXNlciBub3QgZm91bmQiKQ0KICAgICAgICAgICAgcmFpc2UgSFRUUEV4Y2VwdGlvbihzdGF0dXNfY29kZT01MDAsIGRldGFpbD1mIkVycm9yIGRlbGV0aW5nIHVzZXI6IHtzdHIoZSl9IikNCg0KZGJfc2VydmljZSA9IER5bmFtb0RCU2VydmljZSgpDQoNCkBhcHAuZ2V0KCIvaGVhbHRoIikNCmFzeW5jIGRlZiBoZWFsdGhfY2hlY2soKToNCiAgICAiIiJDaGVjayBhcHBsaWNhdGlvbiBoZWFsdGggZm9yIEFMQiIiIg0KICAgIHJldHVybiB7InN0YXR1cyI6ICJPSyJ9DQoNCkBhcHAucG9zdCgiL3VzZXJzIiwgcmVzcG9uc2VfbW9kZWw9VXNlcikNCmFzeW5jIGRlZiBjcmVhdGVfdXNlcih1c2VyOiBVc2VyKToNCiAgICAiIiJDcmVhdGUgYSBuZXcgdXNlciIiIg0KICAgIGRiX3NlcnZpY2UuY3JlYXRlX3VzZXIodXNlcikNCiAgICByZXR1cm4gdXNlcg0KDQpAYXBwLmdldCgiL3VzZXJzL3t1c2VyX2lkfSIsIHJlc3BvbnNlX21vZGVsPVVzZXIpDQphc3luYyBkZWYgcmVhZF91c2VyKHVzZXJfaWQ6IHN0cik6DQogICAgIiIiR2V0IGEgdXNlciBieSBJRCIiIg0KICAgIHJldHVybiBkYl9zZXJ2aWNlLmdldF91c2VyKHVzZXJfaWQpDQoNCkBhcHAuZ2V0KCIvdXNlcnMiLCByZXNwb25zZV9tb2RlbD1MaXN0W1VzZXJdKQ0KYXN5bmMgZGVmIGxpc3RfdXNlcnMoKToNCiAgICAiIiJMaXN0IGFsbCB1c2VycyIiIg0KICAgIHJldHVybiBkYl9zZXJ2aWNlLmxpc3RfdXNlcnMoKQ0KDQpAYXBwLnB1dCgiL3VzZXJzL3t1c2VyX2lkfSIsIHJlc3BvbnNlX21vZGVsPVVzZXIpDQphc3luYyBkZWYgdXBkYXRlX3VzZXIodXNlcl9pZDogc3RyLCB1c2VyX3VwZGF0ZTogVXNlclVwZGF0ZSk6DQogICAgIiIiVXBkYXRlIGEgdXNlciIiIg0KICAgIHJldHVybiBkYl9zZXJ2aWNlLnVwZGF0ZV91c2VyKHVzZXJfaWQsIHVzZXJfdXBkYXRlKQ0KDQpAYXBwLmRlbGV0ZSgiL3VzZXJzL3t1c2VyX2lkfSIpDQphc3luYyBkZWYgZGVsZXRlX3VzZXIodXNlcl9pZDogc3RyKToNCiAgICAiIiJEZWxldGUgYSB1c2VyIiIiDQogICAgZGJfc2VydmljZS5kZWxldGVfdXNlcih1c2VyX2lkKQ0KICAgIHJldHVybiB7Im1lc3NhZ2UiOiBmIlVzZXIge3VzZXJfaWR9IGRlbGV0ZWQgc3VjY2Vzc2Z1bGx5In0NCg0KaWYgX19uYW1lX18gPT0gIl9fbWFpbl9fIjoNCiAgICB1dmljb3JuLnJ1bihhcHAsIGhvc3Q9c2V0dGluZ3MuaG9zdCwgcG9ydD1zZXR0aW5ncy5wb3J0KQ==" | base64 -d > /home/ec2-user/app/app.py
        chown -R ec2-user:ec2-user /home/ec2-user/app
        
        cat > /etc/systemd/system/app-server.service << 'EOF'
[Unit]
Description=App Server
After=network.target

[Service]
Type=exec
User=ec2-user
WorkingDirectory=/home/ec2-user/app
ExecStart=/usr/bin/python3 /home/ec2-user/app/app.py
Restart=always

[Install]
WantedBy=multi-user.target
EOF

        systemctl daemon-reload
        systemctl enable app-server
        systemctl start app-server
    fi
else
    echo "No ECR URL"
    pip3 install fastapi uvicorn boto3 pydantic
    
    mkdir -p /home/ec2-user/app
    echo "ZnJvbSBmYXN0YXBpIGltcG9ydCBGYXN0QVBJCmltcG9ydCB1dmljb3JuCgphcHAgPSBGYXN0QVBJKCkKCkBhcHAuZ2V0KCIvaGVhbHRoIikKYXN5bmMgZGVmIGhlYWx0aF9jaGVjaygpOgogICAgcmV0dXJuIHsic3RhdHVzIjogIk9LIiwgIm1lc3NhZ2UiOiAiQXBwIHNlcnZlciJ9CgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgdXZpY29ybi5ydW4oYXBwLCBob3N0PSIwLjAuMC4wIiwgcG9ydD04MDAwKQ==" | base64 -d > /home/ec2-user/app/app.py
    chown -R ec2-user:ec2-user /home/ec2-user/app
    
    cat > /etc/systemd/system/app-server.service << 'EOF'
[Unit]
Description=App Server
After=network.target

[Service]
Type=exec
User=ec2-user
WorkingDirectory=/home/ec2-user/app
ExecStart=/usr/bin/python3 /home/ec2-user/app/app.py
Restart=always

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable app-server
    systemctl start app-server
fi
