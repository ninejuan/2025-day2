#!/bin/sh

TASK_JSON=$(curl -s "$ECS_CONTAINER_METADATA_URI_V4/task" 2>/dev/null || true)
TASK_ARN=$(printf '%s' "$TASK_JSON" | tr -d '\n' | sed -n 's/.*"Task[Aa][Rr][Nn]"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')
TASK_ID=$(printf '%s' "$TASK_ARN" | awk -F'/' '{print $NF}')
[ -z "$TASK_ID" ] && TASK_ID="unknown"
export ECS_TASK_ID="$TASK_ID"

echo "ECS_TASK_ID: $ECS_TASK_ID"
echo "ECS_CONTAINER_METADATA_URI_V4: $ECS_CONTAINER_METADATA_URI_V4"
echo "TASK_ARN: $TASK_ARN"
echo "TASK_ID: $TASK_ID"

/fluent-bit/bin/fluent-bit -c /fluent-bit/etc/extra.conf